<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Auth Debug Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .console-log {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .debug-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .test-button {
            background: linear-gradient(135deg, #9333ea 0%, #6366f1 100%);
            transition: all 0.3s ease;
        }

        .test-button:hover {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-6 min-h-screen">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                <i class="fas fa-bug mr-3"></i>Supabase Authentication Debug Console
            </h1>
            <p class="text-gray-400">Comprehensive testing and debugging tool for Supabase auth issues</p>
        </div>

        <!-- Configuration Status -->
        <div class="debug-section p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-cog mr-2 text-blue-400"></i>
                Configuration Status
            </h2>
            <div id="configStatus" class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span>Checking Supabase configuration...</span>
                </div>
            </div>
        </div>

        <!-- Test Authentication -->
        <div class="debug-section p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-key mr-2 text-green-400"></i>
                Authentication Test
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="testEmail" placeholder="tuescalarina3@gmail.com"
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none"
                           value="tuescalarina3@gmail.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="testPassword" placeholder="Enter your password"
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none">
                </div>
            </div>

            <div class="flex space-x-4">
                <button id="testSignIn" class="test-button px-6 py-2 rounded-lg text-white font-medium">
                    <i class="fas fa-sign-in-alt mr-2"></i>Test Sign In
                </button>
                <button id="testSession" class="test-button px-6 py-2 rounded-lg text-white font-medium">
                    <i class="fas fa-user-check mr-2"></i>Check Session
                </button>
                <button id="testSignOut" class="test-button px-6 py-2 rounded-lg text-white font-medium">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="debug-section p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-terminal mr-2 text-yellow-400"></i>
                Debug Console
                <button id="clearConsole" class="ml-auto text-sm px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded transition-colors">
                    Clear Console
                </button>
            </h2>
            <div id="debugConsole" class="console-log p-4 rounded-lg">
                <!-- Debug messages will appear here -->
            </div>
        </div>

        <!-- Diagnostic Tools -->
        <div class="debug-section p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-stethoscope mr-2 text-purple-400"></i>
                Diagnostic Tools
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="checkUserExists" class="test-button px-4 py-2 rounded-lg text-white font-medium">
                    <i class="fas fa-search mr-2"></i>Check User Exists
                </button>
                <button id="testEmailVerification" class="test-button px-4 py-2 rounded-lg text-white font-medium">
                    <i class="fas fa-envelope-check mr-2"></i>Check Email Verification
                </button>
                <button id="diagnoseError" class="test-button px-4 py-2 rounded-lg text-white font-medium">
                    <i class="fas fa-microscope mr-2"></i>Diagnose Error
                </button>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="debug-section p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-lightbulb mr-2 text-amber-400"></i>
                Troubleshooting Recommendations
            </h2>
            <div id="recommendations" class="space-y-3 text-gray-300">
                <div class="p-4 bg-blue-900/20 border border-blue-700/30 rounded-lg">
                    <h3 class="font-medium text-blue-400 mb-2">Step 1: Test Your Credentials</h3>
                    <p class="text-sm">Enter your email and password above, then click "Test Sign In" to see detailed debugging information.</p>
                </div>
                <div class="p-4 bg-green-900/20 border border-green-700/30 rounded-lg">
                    <h3 class="font-medium text-green-400 mb-2">Step 2: Check Configuration</h3>
                    <p class="text-sm">The debug console will show you if your Supabase configuration is correct and working.</p>
                </div>
                <div class="p-4 bg-amber-900/20 border border-amber-700/30 rounded-lg">
                    <h3 class="font-medium text-amber-400 mb-2">Step 3: Review Recommendations</h3>
                    <p class="text-sm">Based on the test results, specific recommendations will appear here to help resolve the issue.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Supabase Auth -->
    <script src="/supabase-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const debugConsole = document.getElementById('debugConsole');
            const testEmail = document.getElementById('testEmail');
            const testPassword = document.getElementById('testPassword');

            // Enhanced console logging
            function logToConsole(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
                const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
                debugConsole.textContent += logMessage;
                debugConsole.scrollTop = debugConsole.scrollHeight;
                console.log(logMessage);
            }

            // Clear console
            document.getElementById('clearConsole').addEventListener('click', function() {
                debugConsole.textContent = '';
                logToConsole('Console cleared');
            });

            // Check Supabase configuration
            async function checkConfiguration() {
                const configStatus = document.getElementById('configStatus');

                try {
                    logToConsole('Checking Supabase configuration...');

                    // Wait for Supabase to initialize
                    if (!window.supabaseAuth || !window.supabaseAuth.supabase) {
                        await new Promise(resolve => {
                            setTimeout(resolve, 2000);
                        });
                    }

                    if (window.supabaseAuth && window.supabaseAuth.supabase) {
                        const config = {
                            url: window.supabaseAuth.supabaseUrl,
                            hasKey: !!window.supabaseAuth.supabaseKey,
                            initialized: !!window.supabaseAuth.supabase
                        };

                        configStatus.innerHTML = `
                            <div class="space-y-2">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                    <span>Supabase URL: ${config.url}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                    <span>API Key: ${config.hasKey ? 'Configured' : 'Missing'}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                    <span>Client: ${config.initialized ? 'Initialized' : 'Not initialized'}</span>
                                </div>
                            </div>
                        `;

                        logToConsole('Supabase configuration is valid', 'success');
                        return true;
                    } else {
                        throw new Error('Supabase client not initialized');
                    }
                } catch (error) {
                    configStatus.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                            <span>Configuration Error: ${error.message}</span>
                        </div>
                    `;
                    logToConsole(`Configuration error: ${error.message}`, 'error');
                    return false;
                }
            }

            // Test sign in
            document.getElementById('testSignIn').addEventListener('click', async function() {
                const email = testEmail.value.trim();
                const password = testPassword.value;

                if (!email || !password) {
                    logToConsole('Please enter both email and password', 'warning');
                    return;
                }

                logToConsole(`Testing sign in for: ${email}`);

                try {
                    const result = await window.supabaseAuth.signIn(email, password, false);

                    logToConsole('Sign in result:', 'info');
                    logToConsole(JSON.stringify(result, null, 2), 'info');

                    if (result.success) {
                        logToConsole('Sign in successful!', 'success');
                        updateRecommendations('success', result);
                    } else {
                        logToConsole(`Sign in failed: ${result.error}`, 'error');
                        updateRecommendations('error', result);
                    }
                } catch (error) {
                    logToConsole(`Exception during sign in: ${error.message}`, 'error');
                    updateRecommendations('exception', { error: error.message });
                }
            });

            // Check session
            document.getElementById('testSession').addEventListener('click', async function() {
                logToConsole('Checking current session...');

                try {
                    const user = window.supabaseAuth.getCurrentUser();
                    const isAuth = window.supabaseAuth.isAuthenticated();

                    logToConsole(`Authenticated: ${isAuth}`, 'info');
                    logToConsole(`Current user: ${user ? JSON.stringify(user, null, 2) : 'None'}`, 'info');

                    // Also check Supabase session directly
                    const { data: { session }, error } = await window.supabaseAuth.supabase.auth.getSession();
                    logToConsole(`Supabase session: ${session ? 'Active' : 'None'}`, 'info');
                    if (error) {
                        logToConsole(`Session error: ${error.message}`, 'warning');
                    }
                } catch (error) {
                    logToConsole(`Session check error: ${error.message}`, 'error');
                }
            });

            // Sign out
            document.getElementById('testSignOut').addEventListener('click', async function() {
                logToConsole('Signing out...');

                try {
                    const result = await window.supabaseAuth.signOut();
                    if (result.success) {
                        logToConsole('Sign out successful', 'success');
                    } else {
                        logToConsole(`Sign out error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    logToConsole(`Sign out exception: ${error.message}`, 'error');
                }
            });

            // Check if user exists
            document.getElementById('checkUserExists').addEventListener('click', async function() {
                const email = testEmail.value.trim();
                if (!email) {
                    logToConsole('Please enter an email address', 'warning');
                    return;
                }

                logToConsole(`Checking if user exists: ${email}`);

                // This is a diagnostic check - we'll try to determine if the user exists
                // without triggering password reset attempts
                try {
                    const status = await window.supabaseAuth.checkUserStatus(email);
                    logToConsole(`User status result: ${JSON.stringify(status, null, 2)}`, 'info');

                    if (status.exists) {
                        logToConsole('User exists in the system', 'success');
                    } else {
                        logToConsole('User not found or credentials incorrect', 'warning');
                    }
                } catch (error) {
                    logToConsole(`User check error: ${error.message}`, 'error');
                }
            });

            // Test email verification
            document.getElementById('testEmailVerification').addEventListener('click', async function() {
                const email = testEmail.value.trim();
                if (!email) {
                    logToConsole('Please enter an email address', 'warning');
                    return;
                }

                logToConsole(`Checking email verification for: ${email}`);

                try {
                    // Try to get user info (this will show verification status)
                    const { data, error } = await window.supabaseAuth.supabase.auth.signInWithPassword({
                        email: email,
                        password: 'verification-check-' + Date.now()
                    });

                    if (error) {
                        if (error.message.includes('Invalid login credentials')) {
                            logToConsole('User exists but password check failed (expected for verification test)', 'info');
                        } else if (error.message.includes('Email not confirmed')) {
                            logToConsole('Email is NOT verified', 'warning');
                        } else {
                            logToConsole(`Verification check result: ${error.message}`, 'info');
                        }
                    }
                } catch (error) {
                    logToConsole(`Email verification check error: ${error.message}`, 'error');
                }
            });

            // Diagnose common errors
            document.getElementById('diagnoseError').addEventListener('click', function() {
                logToConsole('Running diagnostic...');

                const email = testEmail.value.trim();

                // Common issue checks
                if (!email) {
                    logToConsole('⚠️ No email provided', 'warning');
                } else if (!email.includes('@')) {
                    logToConsole('⚠️ Invalid email format', 'warning');
                } else {
                    logToConsole(`✅ Email format appears valid: ${email}`, 'success');
                }

                const password = testPassword.value;
                if (!password) {
                    logToConsole('⚠️ No password provided', 'warning');
                } else if (password.length < 8) {
                    logToConsole('⚠️ Password might be too short (Supabase requires 6+ chars)', 'warning');
                } else {
                    logToConsole(`✅ Password length: ${password.length} characters`, 'success');
                }

                // Provide specific recommendations
                logToConsole('', 'info');
                logToConsole('RECOMMENDATIONS:', 'info');
                logToConsole('1. Make sure you\'re using the exact password from signup', 'info');
                logToConsole('2. Check that email verification was completed', 'info');
                logToConsole('3. Try password reset if unsure of credentials', 'info');
                logToConsole('4. Check browser console for additional error details', 'info');
            });

            // Update recommendations based on results
            function updateRecommendations(type, result) {
                const recommendations = document.getElementById('recommendations');

                if (type === 'success') {
                    recommendations.innerHTML = `
                        <div class="p-4 bg-green-900/20 border border-green-700/30 rounded-lg">
                            <h3 class="font-medium text-green-400 mb-2">✅ Authentication Working!</h3>
                            <p class="text-sm mb-3">Your sign in is working correctly. The issue may be resolved.</p>
                            <p class="text-xs text-gray-400">User: ${result.user?.email || 'Unknown'}</p>
                        </div>
                    `;
                } else if (type === 'error') {
                    let recommendationHtml = `
                        <div class="p-4 bg-red-900/20 border border-red-700/30 rounded-lg">
                            <h3 class="font-medium text-red-400 mb-2">❌ Authentication Issue Detected</h3>
                            <p class="text-sm mb-3">Error: ${result.error}</p>
                    `;

                    if (result.error.includes('Invalid login credentials')) {
                        recommendationHtml += `
                            <div class="mt-3 p-3 bg-red-800/20 rounded">
                                <h4 class="text-red-300 font-medium mb-2">SOLUTION:</h4>
                                <ul class="text-sm space-y-1">
                                    <li>• Double-check your password for typos</li>
                                    <li>• Ensure email verification was completed</li>
                                    <li>• Try the "Reset Password" option on the login page</li>
                                    <li>• Check that you're using the correct Supabase project</li>
                                </ul>
                            </div>
                        `;
                    }

                    if (result.needsVerification) {
                        recommendationHtml += `
                            <div class="mt-3 p-3 bg-blue-800/20 rounded">
                                <h4 class="text-blue-300 font-medium mb-2">EMAIL VERIFICATION NEEDED:</h4>
                                <ul class="text-sm space-y-1">
                                    <li>• Check your email inbox for the verification link</li>
                                    <li>• Also check spam/junk folders</li>
                                    <li>• Use the "Resend Verification" option on login page</li>
                                </ul>
                            </div>
                        `;
                    }

                    recommendationHtml += '</div>';
                    recommendations.innerHTML = recommendationHtml;
                }
            }

            // Initialize
            logToConsole('Supabase Debug Console initialized');
            logToConsole('Waiting for Supabase to load...');

            // Check configuration after a short delay
            setTimeout(checkConfiguration, 1000);
        });
    </script>
</body>
</html>