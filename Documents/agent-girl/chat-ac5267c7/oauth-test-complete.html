<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth System Test - Complete Setup</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
            padding: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fafafa;
        }
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }
        .status.success { background: #10b981; color: white; }
        .status.error { background: #ef4444; color: white; }
        .status.pending { background: #f59e0b; color: white; }
        .test-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .log {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .step-number {
            background: #4f46e5;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 16px;
            flex-shrink: 0;
        }
        .step-content {
            flex: 1;
        }
        .code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê OAuth System Test & Setup</h1>
            <p>Complete testing suite for Google OAuth integration</p>
            <p><strong>Server:</strong> http://localhost:3006 | <strong>Client:</strong> http://localhost:5173</p>
        </div>

        <div class="content">
            <!-- Current Status -->
            <div class="section">
                <h2>üéØ Current System Status</h2>
                <div id="status-display">
                    <p>Checking system status...</p>
                </div>
                <button class="test-button" onclick="checkStatus()">Refresh Status</button>
            </div>

            <!-- Critical Setup Instructions -->
            <div class="section">
                <h2>üö® CRITICAL: Google Cloud Console Setup</h2>
                <div class="warning">
                    <strong>‚ö†Ô∏è redirect_uri_mismatch ERROR FIX:</strong><br>
                    You MUST add the following redirect URI to your Google Cloud Console:
                    <div class="code" style="margin: 10px 0; padding: 10px; background: #1f2937; color: white;">
                        http://localhost:3006/auth/google/callback
                    </div>
                </div>

                <h3>Steps to Fix Google Cloud Console:</h3>
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <strong>Go to Google Cloud Console:</strong>
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #3b82f6;">https://console.cloud.google.com/apis/credentials</a>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <strong>Select your OAuth 2.0 Client ID:</strong> placeholder-google-client-id.apps.googleusercontent.com
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <strong>Click "Edit" or "Edit OAuth Client"</strong>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <strong>Add to "Authorized redirect URIs":</strong><br>
                        <div class="code">http://localhost:3006/auth/google/callback</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <strong>Click "Save" or "Update"</strong>
                    </div>
                </div>
            </div>

            <!-- Server Tests -->
            <div class="section">
                <h2>üñ•Ô∏è Server Tests</h2>
                <div class="grid">
                    <div class="card">
                        <h4>Health Check</h4>
                        <p>Test if OAuth server is responding</p>
                        <button class="test-button" onclick="testHealth()">Test Health</button>
                        <div id="health-result"></div>
                    </div>
                    <div class="card">
                        <h4>Auth Status</h4>
                        <p>Check authentication endpoint</p>
                        <button class="test-button" onclick="testAuthStatus()">Test Auth</button>
                        <div id="auth-result"></div>
                    </div>
                    <div class="card">
                        <h4>OAuth Redirect</h4>
                        <p>Test Google OAuth initiation</p>
                        <button class="test-button" onclick="testOAuthRedirect()">Test OAuth</button>
                        <div id="oauth-result"></div>
                    </div>
                </div>
            </div>

            <!-- API Tests (After OAuth) -->
            <div class="section">
                <h2>üîó Google API Tests</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Complete OAuth authentication first, then test APIs</p>
                <div class="grid">
                    <div class="card">
                        <h4>üìß Gmail API</h4>
                        <p>Test Gmail access</p>
                        <button class="test-button" onclick="testGmailAPI()">Test Gmail</button>
                        <div id="gmail-result"></div>
                    </div>
                    <div class="card">
                        <h4>üìÖ Calendar API</h4>
                        <p>Test Calendar access</p>
                        <button class="test-button" onclick="testCalendarAPI()">Test Calendar</button>
                        <div id="calendar-result"></div>
                    </div>
                    <div class="card">
                        <h4>üë• Contacts API</h4>
                        <p>Test Contacts access</p>
                        <button class="test-button" onclick="testContactsAPI()">Test Contacts</button>
                        <div id="contacts-result"></div>
                    </div>
                </div>
            </div>

            <!-- OAuth Flow Test -->
            <div class="section">
                <h2>üîÑ Complete OAuth Flow Test</h2>
                <p>This will open a popup window for Google OAuth authentication</p>
                <button class="test-button" onclick="startOAuthFlow()">
                    üîê Start Google OAuth Flow
                </button>
                <div id="oauth-flow-result"></div>
            </div>

            <!-- Live Log -->
            <div class="section">
                <h2>üìã Live Test Log</h2>
                <button class="test-button" onclick="clearLog()">Clear Log</button>
                <div id="log" class="log">Test log will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3006';
        const CLIENT_BASE = 'http://localhost:5173';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#f3f4f6';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared');
        }

        async function checkStatus() {
            const statusDiv = document.getElementById('status-display');
            log('üîç Checking system status...');

            try {
                // Check OAuth server
                const healthResponse = await fetch(`${API_BASE}/health`);
                const serverStatus = healthResponse.ok ?
                    '<span class="status success">‚úÖ OAuth Server Online</span>' :
                    '<span class="status error">‚ùå OAuth Server Down</span>';

                // Check React app
                const clientResponse = await fetch(`${CLIENT_BASE}`);
                const clientStatus = clientResponse.ok ?
                    '<span class="status success">‚úÖ React App Online</span>' :
                    '<span class="status error">‚ùå React App Down</span>';

                statusDiv.innerHTML = `
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        ${serverStatus}
                        ${clientStatus}
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>OAuth Server:</strong> ${API_BASE}<br>
                        <strong>React App:</strong> ${CLIENT_BASE}<br>
                        <strong>Google Client ID:</strong> placeholder-google-client-id.apps.googleusercontent.com
                    </div>
                `;

                log('‚úÖ System status check complete', 'success');
            } catch (error) {
                statusDiv.innerHTML = '<span class="status error">‚ùå Error checking system status</span>';
                log(`‚ùå Status check failed: ${error.message}`, 'error');
            }
        }

        async function testHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.innerHTML = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div style="color: #10b981; font-weight: bold;">‚úÖ Success</div>
                    <div>Server: ${data.server}</div>
                    <div>Port: ${data.port}</div>
                `;
                log(`‚úÖ Health check successful: ${data.server} on port ${data.port}`, 'success');
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Failed: ${error.message}</div>`;
                log(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        async function testAuthStatus() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/auth/status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div style="color: ${data.authenticated ? '#10b981' : '#f59e0b'};">
                        ${data.authenticated ? '‚úÖ Authenticated' : '‚≠ï Not Authenticated'}
                    </div>
                    <div>User: ${data.user ? data.user.email : 'None'}</div>
                    <div>Google: ${data.services.google ? '‚úÖ Connected' : '‚ùå Not connected'}</div>
                `;
                log(`‚úÖ Auth status: ${data.authenticated ? 'Authenticated' : 'Not authenticated'}`, 'success');
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Failed: ${error.message}</div>`;
                log(`‚ùå Auth status check failed: ${error.message}`, 'error');
            }
        }

        async function testOAuthRedirect() {
            const resultDiv = document.getElementById('oauth-result');
            resultDiv.innerHTML = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/auth/google`, {
                    redirect: 'manual'
                });

                const location = response.headers.get('Location');
                if (location && location.includes('accounts.google.com')) {
                    resultDiv.innerHTML = `
                        <div style="color: #10b981;">‚úÖ OAuth Redirect Working</div>
                        <div style="font-size: 12px; word-break: break-all;">${location.substring(0, 100)}...</div>
                    `;
                    log('‚úÖ OAuth redirect test successful', 'success');
                } else {
                    throw new Error('Invalid OAuth redirect');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Failed: ${error.message}</div>`;
                log(`‚ùå OAuth redirect test failed: ${error.message}`, 'error');
            }
        }

        async function testGmailAPI() {
            const resultDiv = document.getElementById('gmail-result');
            resultDiv.innerHTML = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/gmail/test`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div style="color: #10b981;">‚úÖ Gmail API Working</div>
                        <div>Emails: ${data.profile?.messagesTotal || 'N/A'}</div>
                    `;
                    log('‚úÖ Gmail API test successful', 'success');
                } else {
                    throw new Error(data.error || 'Authentication required');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Failed: ${error.message}</div>`;
                log(`‚ùå Gmail API test failed: ${error.message}`, 'error');
            }
        }

        async function testCalendarAPI() {
            const resultDiv = document.getElementById('calendar-result');
            resultDiv.innerHTML = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/calendar/test`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div style="color: #10b981;">‚úÖ Calendar API Working</div>
                        <div>Events found: ${data.events?.length || 0}</div>
                    `;
                    log(`‚úÖ Calendar API test successful: ${data.events?.length || 0} events found`, 'success');
                } else {
                    throw new Error(data.error || 'Authentication required');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Failed: ${error.message}</div>`;
                log(`‚ùå Calendar API test failed: ${error.message}`, 'error');
            }
        }

        async function testContactsAPI() {
            const resultDiv = document.getElementById('contacts-result');
            resultDiv.innerHTML = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/contacts/test`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div style="color: #10b981;">‚úÖ Contacts API Working</div>
                        <div>Contacts: ${data.contacts?.length || 0}</div>
                    `;
                    log(`‚úÖ Contacts API test successful: ${data.contacts?.length || 0} contacts found`, 'success');
                } else {
                    throw new Error(data.error || 'Authentication required');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Failed: ${error.message}</div>`;
                log(`‚ùå Contacts API test failed: ${error.message}`, 'error');
            }
        }

        function startOAuthFlow() {
            const resultDiv = document.getElementById('oauth-flow-result');
            resultDiv.innerHTML = 'Opening OAuth popup...';
            log('üîê Starting OAuth flow...', 'info');

            const width = 500;
            const height = 600;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;

            const popup = window.open(
                `${API_BASE}/auth/google`,
                'google-oauth',
                `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            if (!popup) {
                resultDiv.innerHTML = '<div style="color: #ef4444;">‚ùå Failed to open popup. Allow popups for localhost.</div>';
                log('‚ùå Failed to open OAuth popup - check popup settings', 'error');
                return;
            }

            resultDiv.innerHTML = '<div style="color: #3b82f6;">‚è≥ Waiting for authentication...</div>';

            // Listen for messages from the popup
            const messageHandler = (event) => {
                if (event.data.type === 'oauth-callback') {
                    window.removeEventListener('message', messageHandler);

                    if (event.data.success) {
                        resultDiv.innerHTML = '<div style="color: #10b981;">‚úÖ Google OAuth Successful!</div>';
                        log('‚úÖ OAuth flow completed successfully', 'success');

                        // Refresh auth status
                        setTimeout(testAuthStatus, 1000);
                    } else {
                        resultDiv.innerHTML = `<div style="color: #ef4444;">‚ùå OAuth Failed: ${event.data.error}</div>`;
                        log(`‚ùå OAuth flow failed: ${event.data.error}`, 'error');
                    }

                    popup.close();
                }
            };

            window.addEventListener('message', messageHandler);

            // Check if popup was closed manually
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    window.removeEventListener('message', messageHandler);
                    resultDiv.innerHTML = '<div style="color: #f59e0b;">‚ö†Ô∏è OAuth popup was closed</div>';
                    log('‚ö†Ô∏è OAuth popup was closed by user', 'error');
                }
            }, 1000);

            // Timeout after 5 minutes
            setTimeout(() => {
                clearInterval(checkClosed);
                window.removeEventListener('message', messageHandler);
                if (!popup.closed) {
                    popup.close();
                    resultDiv.innerHTML = '<div style="color: #ef4444;">‚ùå OAuth flow timed out</div>';
                    log('‚ùå OAuth flow timed out', 'error');
                }
            }, 5 * 60 * 1000);
        }

        // Auto-check status on page load
        window.addEventListener('load', () => {
            log('üöÄ OAuth System Test Suite loaded');
            checkStatus();
        });
    </script>
</body>
</html>