<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Debug Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Password Reset Debug Tool</h1>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Current URL Analysis</h2>
            <div id="urlAnalysis" class="font-mono text-sm bg-gray-100 p-4 rounded"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test URL Generator</h2>
            <p class="mb-4">Generate test URLs to simulate Supabase password reset links:</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Email:</label>
                    <input type="email" id="testEmail" value="tuescalarina3@gmail.com" class="w-full border rounded px-3 py-2">
                </div>

                <button onclick="generateTestURLs()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Generate Test URLs
                </button>

                <div id="testURLs" class="mt-4 space-y-2"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">URL Parser Test</h2>
            <p class="mb-4">Test the URL parsing logic with different formats:</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Test URL:</label>
                    <input type="text" id="testURL" placeholder="Enter a URL to test" class="w-full border rounded px-3 py-2">
                </div>

                <button onclick="testURLParsing()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Test URL Parsing
                </button>

                <div id="parsingResults" class="mt-4 font-mono text-sm bg-gray-100 p-4 rounded"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Actions</h2>
            <div class="space-x-4">
                <button onclick="window.location.href='reset-password.html'" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Go to Reset Page
                </button>
                <button onclick="testPasswordResetFlow()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    Test Full Flow
                </button>
            </div>
        </div>
    </div>

    <script>
        // Parse URL parameters (same logic as reset-password.html)
        function parseResetURL(url) {
            let accessToken = null;
            let refreshToken = null;
            let email = null;
            let isResetFlow = false;

            // Create URL object for easier parsing
            const urlObj = new URL(url);

            // Method 1: Check hash fragment first (Supabase default method)
            const hash = urlObj.hash;
            if (hash) {
                console.log('üîç Found hash fragment:', hash);

                // Remove # and parse
                const hashParams = new URLSearchParams(hash.substring(1));

                // Check for access_token (Supabase uses this for password resets)
                accessToken = hashParams.get('access_token');
                refreshToken = hashParams.get('refresh_token');
                email = hashParams.get('email');

                if (accessToken) {
                    isResetFlow = true;
                    console.log('‚úÖ Detected Supabase password reset flow via access_token');
                }
            }

            // Method 2: Check query parameters (fallback)
            if (!isResetFlow) {
                const urlParams = new URLSearchParams(urlObj.search);
                const queryToken = urlParams.get('token');
                const queryEmail = urlParams.get('email');

                if (queryToken && queryEmail) {
                    accessToken = queryToken;
                    email = queryEmail;
                    isResetFlow = true;
                    console.log('‚úÖ Detected reset flow via query parameters');
                }
            }

            // Method 3: Check URL path parameters
            if (!isResetFlow && url.includes('access_token=')) {
                const params = new URLSearchParams(urlObj.search);

                accessToken = params.get('access_token');
                refreshToken = params.get('refresh_token');
                email = params.get('email');

                if (accessToken) {
                    isResetFlow = true;
                    console.log('‚úÖ Detected reset flow via URL search params');
                }
            }

            return {
                accessToken,
                refreshToken,
                email,
                isResetFlow,
                originalURL: url,
                hash: urlObj.hash,
                search: urlObj.search
            };
        }

        // Initialize URL analysis
        function initializeAnalysis() {
            const currentURL = window.location.href;
            const analysis = parseResetURL(currentURL);

            document.getElementById('urlAnalysis').innerHTML = `
                <div class="space-y-2">
                    <div><strong>Full URL:</strong> ${currentURL}</div>
                    <div><strong>Hash:</strong> ${analysis.hash || '(none)'}</div>
                    <div><strong>Search:</strong> ${analysis.search || '(none)'}</div>
                    <div><strong>Is Reset Flow:</strong> ${analysis.isResetFlow ? '‚úÖ YES' : '‚ùå NO'}</div>
                    <div><strong>Access Token:</strong> ${analysis.accessToken ? `${analysis.accessToken.substring(0, 20)}... (${analysis.accessToken.length} chars)` : '(none)'}</div>
                    <div><strong>Refresh Token:</strong> ${analysis.refreshToken ? `${analysis.refreshToken.substring(0, 20)}... (${analysis.refreshToken.length} chars)` : '(none)'}</div>
                    <div><strong>Email:</strong> ${analysis.email || '(none)'}</div>
                </div>
            `;
        }

        // Generate test URLs
        function generateTestURLs() {
            const email = document.getElementById('testEmail').value;
            const baseURL = window.location.origin;
            const testAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test-access-token-for-debugging-purposes-only';
            const testRefreshToken = 'test-refresh-token-for-debugging-purposes-only';

            const testURLs = [
                // Supabase hash format (most common)
                `${baseURL}/reset-password.html#access_token=${encodeURIComponent(testAccessToken)}&refresh_token=${encodeURIComponent(testRefreshToken)}&email=${encodeURIComponent(email)}`,

                // Query parameter format
                `${baseURL}/reset-password.html?token=${encodeURIComponent(testAccessToken)}&email=${encodeURIComponent(email)}`,

                // Alternative hash format
                `${baseURL}/reset-password.html#token=${encodeURIComponent(testAccessToken)}&email=${encodeURIComponent(email)}`,

                // Direct URL search format
                `${baseURL}/reset-password.html?access_token=${encodeURIComponent(testAccessToken)}&refresh_token=${encodeURIComponent(testRefreshToken)}&email=${encodeURIComponent(email)}`
            ];

            const html = testURLs.map((url, index) => `
                <div class="border rounded p-3">
                    <div class="text-sm font-medium mb-2">Format ${index + 1}:</div>
                    <div class="font-mono text-xs break-all mb-2">${url}</div>
                    <button onclick="window.open('${url}', '_blank')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        Test This URL
                    </button>
                </div>
            `).join('');

            document.getElementById('testURLs').innerHTML = html;
        }

        // Test URL parsing
        function testURLParsing() {
            const testURL = document.getElementById('testURL').value;
            if (!testURL) {
                alert('Please enter a URL to test');
                return;
            }

            const analysis = parseResetURL(testURL);

            document.getElementById('parsingResults').innerHTML = `
                <div class="space-y-2">
                    <div><strong>Input URL:</strong> ${testURL}</div>
                    <div><strong>Is Reset Flow:</strong> ${analysis.isResetFlow ? '‚úÖ YES' : '‚ùå NO'}</div>
                    <div><strong>Access Token Found:</strong> ${analysis.accessToken ? '‚úÖ YES' : '‚ùå NO'}</div>
                    <div><strong>Refresh Token Found:</strong> ${analysis.refreshToken ? '‚úÖ YES' : '‚ùå NO'}</div>
                    <div><strong>Email Found:</strong> ${analysis.email ? '‚úÖ YES' : '‚ùå NO'}</div>
                    <div><strong>Hash Fragment:</strong> ${analysis.hash || '(none)'}</div>
                    <div><strong>Query String:</strong> ${analysis.search || '(none)'}</div>
                </div>
            `;
        }

        // Test full password reset flow
        function testPasswordResetFlow() {
            // Simulate what would happen with a real Supabase URL
            const testURL = `${window.location.origin}/reset-password.html#access_token=test-token&refresh_token=test-refresh&email=tuescalarina3@gmail.com`;

            const analysis = parseResetURL(testURL);
            console.log('Full flow test analysis:', analysis);

            alert(`This will test the full flow with URL: ${testURL}\n\nOpening in new tab...`);
            window.open(testURL, '_blank');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeAnalysis();
            generateTestURLs();
        });
    </script>
</body>
</html>