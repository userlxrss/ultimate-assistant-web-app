<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 20px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            color: #1f2937;
            margin: 0 0 0.5rem;
            font-size: 1.5rem;
        }
        p {
            color: #6b7280;
            margin: 0;
        }
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Processing Motion Authentication</h1>
        <p>Please wait while we connect your account...</p>
        <div id="message"></div>
    </div>

    <script>
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            const messageDiv = document.getElementById('message');

            if (error) {
                document.querySelector('.spinner').style.display = 'none';
                document.querySelector('h1').textContent = 'Authentication Failed';
                messageDiv.innerHTML = `<div class="error">Error: ${error}</div>`;

                // Send error message to parent window
                try {
                    window.opener.postMessage({
                        type: 'motion-oauth-callback',
                        success: false,
                        error: error
                    }, '*');
                } catch (e) {
                    console.error('Failed to send error message:', e);
                }

                setTimeout(() => {
                    window.close();
                }, 3000);
                return;
            }

            if (!code || !state) {
                document.querySelector('.spinner').style.display = 'none';
                document.querySelector('h1').textContent = 'Invalid Response';
                messageDiv.innerHTML = '<div class="error">Missing required authentication parameters</div>';

                // Send error message to parent window
                try {
                    window.opener.postMessage({
                        type: 'motion-oauth-callback',
                        success: false,
                        error: 'Missing required authentication parameters'
                    }, '*');
                } catch (e) {
                    console.error('Failed to send error message:', e);
                }

                setTimeout(() => {
                    window.close();
                }, 3000);
                return;
            }

            // For demo purposes, create fake OAuth tokens
            // In production, you would exchange the code for real tokens
            const fakeTokens = {
                access_token: 'fake_oauth_access_token_' + Math.random().toString(36).substring(7),
                refresh_token: 'fake_oauth_refresh_token_' + Math.random().toString(36).substring(7),
                expiresAt: Date.now() + (60 * 60 * 1000), // 1 hour from now
                scope: 'tasks:read tasks:write calendar:read'
            };

            const fakeUser = {
                id: 'user_' + Math.random().toString(36).substring(7),
                email: 'user@demo.motion.com',
                name: 'Demo User',
                timezone: 'UTC'
            };

            // Store OAuth tokens in localStorage
            localStorage.setItem('motion_oauth_tokens', JSON.stringify(fakeTokens));
            localStorage.setItem('motion_oauth_user', JSON.stringify(fakeUser));

            console.log('✅ Motion OAuth tokens stored:', { user: fakeUser.email });

            // Show success message
            document.querySelector('.spinner').style.display = 'none';
            document.querySelector('h1').textContent = 'Motion Connected!';
            messageDiv.innerHTML = `
                <div class="success">
                    Successfully connected to Motion as ${fakeUser.name} (${fakeUser.email})
                </div>
                <p style="margin-top: 1rem; color: #16a34a;">Closing this window...</p>
            `;

            // Send success message to parent window (for popup OAuth)
            try {
                window.opener.postMessage({
                    type: 'motion-oauth-callback',
                    success: true,
                    user: fakeUser,
                    tokens: fakeTokens
                }, '*');

                console.log('✅ Motion OAuth success message sent to parent window');
            } catch (error) {
                console.error('Failed to send OAuth success message:', error);
                // Fallback: redirect if popup messaging fails
                window.location.href = '/settings?motion_auth_success=true';
                return;
            }

            // Close popup window after a short delay
            setTimeout(() => {
                window.close();
            }, 1500);
        }

        // Handle the callback when page loads
        document.addEventListener('DOMContentLoaded', handleOAuthCallback);

        // Also handle if page is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', handleOAuthCallback);
        } else {
            handleOAuthCallback();
        }
    </script>
</body>
</html>