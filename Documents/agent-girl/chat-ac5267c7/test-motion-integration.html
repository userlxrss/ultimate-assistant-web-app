<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion API Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .loading { border-left-color: #ffc107; background: #fff3cd; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .task-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .task-title { font-weight: 600; }
        .task-meta { font-size: 12px; color: #6c757d; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Motion API Integration Test</h1>
        <p>This page tests the Motion API integration to debug why tasks aren't loading in the main application.</p>

        <div id="env-test" class="test-section loading">
            <h3>üîë Environment Variables</h3>
            <p>Testing if VITE_MOTION_API_KEY is available...</p>
            <div id="env-result"></div>
        </div>

        <div id="api-test" class="test-section loading">
            <h3>üåê Motion API Test</h3>
            <button onclick="testMotionAPI()" id="test-btn">Test Motion API Connection</button>
            <div id="api-result"></div>
        </div>

        <div id="tasks-display" class="test-section" style="display: none;">
            <h3>üìã Sample Tasks from Motion</h3>
            <div id="tasks-list"></div>
        </div>
    </div>

    <script type="module">
        // Test environment variables
        function testEnvironmentVariables() {
            const envSection = document.getElementById('env-test');
            const envResult = document.getElementById('env-result');

            console.log('Testing environment variables...');
            console.log('import.meta.env:', import.meta.env);
            console.log('VITE_MOTION_API_KEY available:', !!import.meta.env.VITE_MOTION_API_KEY);

            if (import.meta.env.VITE_MOTION_API_KEY) {
                envSection.className = 'test-section success';
                envResult.innerHTML = `
                    <p><strong>‚úÖ SUCCESS:</strong> Environment variable found!</p>
                    <p><strong>API Key starts with:</strong> ${import.meta.env.VITE_MOTION_API_KEY.substring(0, 10)}...</p>
                    <p><strong>Key length:</strong> ${import.meta.env.VITE_MOTION_API_KEY.length} characters</p>
                `;
            } else {
                envSection.className = 'test-section error';
                envResult.innerHTML = `
                    <p><strong>‚ùå ERROR:</strong> VITE_MOTION_API_KEY not found!</p>
                    <p><strong>Available env vars:</strong></p>
                    <pre>${JSON.stringify(Object.keys(import.meta.env), null, 2)}</pre>
                `;
            }
        }

        // Test Motion API connection
        window.testMotionAPI = async function() {
            const apiSection = document.getElementById('api-test');
            const apiResult = document.getElementById('api-result');
            const testBtn = document.getElementById('test-btn');

            if (!import.meta.env.VITE_MOTION_API_KEY) {
                apiSection.className = 'test-section error';
                apiResult.innerHTML = '<p>‚ùå Cannot test API - no environment variable found!</p>';
                return;
            }

            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            apiSection.className = 'test-section loading';
            apiResult.innerHTML = '<p>üîÑ Testing Motion API connection...</p>';

            try {
                console.log('Making request to Motion API proxy...');

                const response = await fetch('http://localhost:3013/api/motion/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey: import.meta.env.VITE_MOTION_API_KEY
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    apiSection.className = 'test-section success';
                    apiResult.innerHTML = `
                        <p><strong>‚úÖ SUCCESS:</strong> Motion API connection working!</p>
                        <p><strong>Tasks retrieved:</strong> ${data.data.tasks.length}</p>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;

                    // Show sample tasks
                    displaySampleTasks(data.data.tasks.slice(0, 5));
                } else {
                    apiSection.className = 'test-section error';
                    apiResult.innerHTML = `
                        <p><strong>‚ùå ERROR:</strong> Motion API returned error</p>
                        <p><strong>Error:</strong> ${data.error}</p>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                console.error('Motion API test error:', error);
                apiSection.className = 'test-section error';
                apiResult.innerHTML = `
                    <p><strong>‚ùå ERROR:</strong> Failed to connect to Motion API</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Check:</strong> Is the proxy server running on localhost:3013?</p>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Motion API Connection';
            }
        };

        function displaySampleTasks(tasks) {
            const tasksSection = document.getElementById('tasks-display');
            const tasksList = document.getElementById('tasks-list');

            if (tasks.length === 0) {
                tasksList.innerHTML = '<p>No tasks to display.</p>';
            } else {
                tasksList.innerHTML = tasks.map(task => `
                    <div class="task-item">
                        <div class="task-title">${task.name}</div>
                        <div class="task-meta">
                            üìÖ Due: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date'} |
                            ‚è±Ô∏è Duration: ${task.duration}min |
                            üè∑Ô∏è Status: ${task.status?.name || task.status || 'Unknown'}
                        </div>
                        ${task.description ? `<div style="margin-top: 8px; font-size: 13px;">${task.description.replace(/<[^>]*>/g, '').substring(0, 100)}...</div>` : ''}
                    </div>
                `).join('');
            }

            tasksSection.style.display = 'block';
        }

        // Run environment test on page load
        testEnvironmentVariables();
    </script>
</body>
</html>